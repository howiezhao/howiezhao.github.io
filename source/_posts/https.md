---
title: HTTPS 运行机制
date: 2018-05-11 18:45:45
categories: CheatSheet
tags:
  - 计算机网络
---

## 信息安全三要素

信息安全三要素即**机密性**（Confidentiality）、**完整性**（Integrity）和**可用性**（Availability），简称 **CIA**。

- 机密性：仅有发送方和希望的接收方能够理解传输报文的内容。因为窃听者可以截获报文，这必须要求报文在一定程度上进行加密，使截取的报文无法被截获者所理解。机密性的这个方面大概就是通常意义上对于术语 *信息安全* 的理解。
- 完整性：或称 *报文完整性* 或 *报文鉴别*，即通信双方希望确保其通信的内容在传输过程中未被改变 —— 或者恶意篡改或者意外改动。我们在可靠数据传输和数据链路协议中遇到的 *检验和* 技术在扩展后能够用于提供这种报文完整性。

## 公钥认证

公钥认证（public key certification）即证实一个公钥属于某个特定的实体。将公钥与特定实体绑定通常是由**认证中心**（Certification Authority，**CA**）完成的，CA 的职责就是使识别和发行证书合法化。CA 具有下列作用：

- CA 证实一个实体（一个人、一台路由器等）的真实身份。
- 一旦 CA 验证了某个实体的身份，这个 CA 会生成一个将其身份和实体的公钥绑定起来的**证书**（certificate）。这个证书包含这个公钥和公钥所有者全局唯一的身份标识信息（例如，一个人的名字或一个 IP 地址）。由 CA 对这个证书进行数字签名。

## SSL 与 TLS

SSL（Secure Socket Layer，**安全套接字层**）最初由 Netscape 设计，其发展到现在存在一些设计上的漏洞，SSL 版本 3 的一个稍加修改的版本被称为 TLS（Transport Layer Security，**传输层安全性**）。

现在为了安全性基本都采用 TLS，本文以下内容采用 SSL 来指代最新的 TLS。

SSL 经常用来为发生在 HTTP 之上的事务提供安全性。然而，因为 SSL 使 TCP 安全了，因此它能被应用于运行在 TCP 之上的任何应用程序。

## SSL 工作过程

SSL 具有三个阶段：**握手**、**密钥导出**和**数据传输**：

### 握手

SSL 握手步骤如下：

1. 客户发送它支持的密码算法的列表，连同一个客户的**不重数**（nonce）。
2. 从该列表中，服务器选择一种对称算法（例如 AES）、一种公钥算法（例如具有特定密钥长度的 RSA）和一种 MAC 算法。它把它的选择以及证书和一个服务器不重数返回给客户。
3. 客户验证该证书，提取服务器的公钥，生成一个**前主密钥**（Pre-Master Secret，PMS），用服务器的公钥加密该 PMS，并将加密的 PMS 发送给服务器。
4. 使用相同的密钥导出函数（就像 SSL 标准定义的那样），客户和服务器独立地从 PMS 和不重数中计算出**主密钥**（Master Secret，MS）。
5. 客户发送所有握手报文的一个 MAC。
6. 服务器发送所有握手报文的一个 MAC。

### 密钥导出

客户和服务器都使用 MS 生成 4 个密钥：

- E_C：用于从客户发送到服务器的数据的会话加密密钥
- M_C：用于从客户发送到服务器的数据的会话 MAC 密钥
- E_S：用于从服务器发送到客户的数据的会话加密密钥
- M_S：用于从服务器发送到客户的数据的会话 MAC 密钥

### 数据传输

由于 TCP 是一种字节流协议，SSL 将数据流分割成 *记录*，对每个记录附加一个 MAC 用于完整性检查，然后加密该“记录+MAC”。为了产生这个 MAC，客户将数据连同密钥 M_C 放入一个散列函数中；为了加密“记录+MAC”这个包，客户使用它的会话加密密钥 E_C。然后这个加密的包将传递给 TCP 经因特网传输。
